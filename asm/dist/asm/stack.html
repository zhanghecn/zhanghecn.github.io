<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>堆栈与函数 | ASM</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="ASM教程">
    
    <link rel="preload" href="/asm/dist/assets/css/0.styles.bcf31e2a.css" as="style"><link rel="preload" href="/asm/dist/assets/js/app.6634fcdc.js" as="script"><link rel="preload" href="/asm/dist/assets/js/2.c8a9966a.js" as="script"><link rel="preload" href="/asm/dist/assets/js/16.5fc6bad5.js" as="script"><link rel="prefetch" href="/asm/dist/assets/js/10.bcf60c5c.js"><link rel="prefetch" href="/asm/dist/assets/js/11.548c431c.js"><link rel="prefetch" href="/asm/dist/assets/js/12.1e9ff982.js"><link rel="prefetch" href="/asm/dist/assets/js/13.cee08286.js"><link rel="prefetch" href="/asm/dist/assets/js/14.0c34b073.js"><link rel="prefetch" href="/asm/dist/assets/js/15.55afd9f3.js"><link rel="prefetch" href="/asm/dist/assets/js/17.70286e2b.js"><link rel="prefetch" href="/asm/dist/assets/js/18.8ef81a29.js"><link rel="prefetch" href="/asm/dist/assets/js/19.3afd398b.js"><link rel="prefetch" href="/asm/dist/assets/js/20.5d3c78e4.js"><link rel="prefetch" href="/asm/dist/assets/js/21.f610ef5f.js"><link rel="prefetch" href="/asm/dist/assets/js/22.ee117ac9.js"><link rel="prefetch" href="/asm/dist/assets/js/23.c03a1a4d.js"><link rel="prefetch" href="/asm/dist/assets/js/24.7537d8de.js"><link rel="prefetch" href="/asm/dist/assets/js/3.f5310743.js"><link rel="prefetch" href="/asm/dist/assets/js/4.bc7cf726.js"><link rel="prefetch" href="/asm/dist/assets/js/5.d250cb53.js"><link rel="prefetch" href="/asm/dist/assets/js/6.8779df89.js"><link rel="prefetch" href="/asm/dist/assets/js/7.cf8be782.js"><link rel="prefetch" href="/asm/dist/assets/js/8.f2edada3.js"><link rel="prefetch" href="/asm/dist/assets/js/9.fb834f7f.js">
    <link rel="stylesheet" href="/asm/dist/assets/css/0.styles.bcf31e2a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/asm/dist/" class="home-link router-link-active"><!----> <span class="site-name">ASM</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/asm/dist/" class="nav-link">
  主页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/asm/dist/" class="nav-link">
  主页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/asm/dist/AsmSummarize.html" class="sidebar-link">asm教程概述</a></li><li><a href="/asm/dist/visualstudio/" class="sidebar-link">Visual Studio</a></li><li><a href="/asm/dist/cplus/" class="sidebar-link">c++基础</a></li><li><a href="/asm/dist/cplus/cClass.html" class="sidebar-link">C++的类</a></li><li><a href="/asm/dist/cplus/cAdvanced.html" class="sidebar-link">C++ 进阶</a></li><li><a href="/asm/dist/cplus/dll.html" class="sidebar-link">DLL</a></li><li><a href="/asm/dist/cplus/CC.html" class="sidebar-link">C#</a></li><li><a href="/asm/dist/asm/" aria-current="page" class="sidebar-link">asm概述</a></li><li><a href="/asm/dist/asm/basic.html" class="sidebar-link">asm基础</a></li><li><a href="/asm/dist/asm/operator.html" class="sidebar-link">asm运算符和指令</a></li><li><a href="/asm/dist/asm/stack.html" aria-current="page" class="active sidebar-link">堆栈与函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/asm/dist/asm/stack.html#堆栈" class="sidebar-link">堆栈</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/stack.html#push-和-pop" class="sidebar-link">push 和 pop</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/stack.html#call" class="sidebar-link">call</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/stack.html#调用内置链接库" class="sidebar-link">调用内置链接库</a></li></ul></li><li><a href="/asm/dist/asm/bool.html" class="sidebar-link">汇编条件跳转判断</a></li><li><a href="/asm/dist/asm/function.html" class="sidebar-link">高级函数过程</a></li><li><a href="/asm/dist/asm/float.html" class="sidebar-link">浮点数</a></li><li><a href="/asm/dist/asm/example.html" class="sidebar-link">汇编示例</a></li><li><a href="/asm/dist/ddt/" class="sidebar-link">弹弹堂</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="堆栈与函数"><a href="#堆栈与函数" class="header-anchor">#</a> 堆栈与函数</h1> <h2 id="堆栈"><a href="#堆栈" class="header-anchor">#</a> 堆栈</h2> <p>堆栈是一种数据结构(LIFO last-in first outer) 后进先出</p> <p><strong>运行时的堆栈</strong></p> <p>运行时的堆栈是一个数组 CPU用寄存器的ESP（堆栈指针 stack pointer register）来进行管理</p> <p>32位模式下，esp寄存器存放的是堆栈中某个位置的32位偏移量 esp基本不会被人为控制,
它是用于call ret push pop 等函数指令间接修改</p> <ol><li>入栈:</li></ol> <p><img src="/img_5.png'" alt="img">&quot; alt=&quot;foo&quot;&gt;</p> <p>32位的栈的指针隔着4字节的地址 每入栈一个esp就指向那个一个</p> <ol start="2"><li>出栈:</li></ol> <p><img src="/img_6.png'" alt="img">&quot; alt=&quot;foo&quot;&gt;</p> <blockquote><p>堆栈可为局部变量提供临时存储区</p></blockquote> <blockquote><p>调用函数过程的时候,输入的参数也可通过压入堆栈来传递</p></blockquote> <blockquote><p>执行call 函数的时候,cpu在堆栈中保持ret返回的地址</p></blockquote> <blockquote><p>也可用来撤销之前的操作</p></blockquote> <blockquote><p>汇编理的栈的最大空间为64kb</p></blockquote> <h2 id="push-和-pop"><a href="#push-和-pop" class="header-anchor">#</a> push 和 pop</h2> <p>栈的初始esp指针是指向高位的,每添加一个指针 esp即增加,反之减少</p> <ol><li><p>push 指令
push指令压入一个内容值,随之esp指针增加
另外还有一个pushfd 压入eflags的状态寄存器内容</p></li> <li><p>pop 指令
pop指令弹出esp指针对应的内容,切且esp减少
另外还有一个 popfd 恢复eflags 状态寄存器内容</p></li> <li><p>ad(all directive)指令
pushad 压入所有寄存器(eax,ecx,edx,ebx,esp(执行之前的指针),ebp,esi,edi);
popad 相反顺序寄存器弹出堆栈</p></li> <li><p>示例
下面是讲一个数组的数字通过栈的后进先出策略反转数据</p></li></ol> <ul><li>asm</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token punctuation">.</span>data
narray dword <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">;</span>

<span class="token punctuation">.</span>code 
reversal proc
mov rcx<span class="token punctuation">,</span>lengthof narray<span class="token punctuation">;</span> <span class="token comment">//获取长度</span>
mov rsi<span class="token punctuation">,</span>offset narray<span class="token punctuation">;</span>
mov rdi<span class="token punctuation">,</span>rsi<span class="token punctuation">;</span>

<span class="token punctuation">;</span><span class="token comment">//存栈</span>
L1<span class="token operator">:</span> 
 movzx rax<span class="token punctuation">,</span>byte ptr <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//左侧填充0  如: 00000001</span>
 add rdi<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">//地址偏移++</span>
 push rax<span class="token punctuation">;</span> <span class="token comment">//存栈</span>
loop L1<span class="token punctuation">;</span>

mov rcx<span class="token punctuation">,</span>lengthof narray<span class="token punctuation">;</span>
mov rdi<span class="token punctuation">,</span>rsi<span class="token punctuation">;</span>

<span class="token punctuation">;</span><span class="token comment">//弹出值获取</span>
L2<span class="token operator">:</span>
 pop rax<span class="token punctuation">;</span> 
 mov <span class="token punctuation">[</span>rdi<span class="token punctuation">]</span><span class="token punctuation">,</span>eax<span class="token punctuation">;</span>
 add rdi<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">;</span>
loop L2<span class="token punctuation">;</span>

<span class="token punctuation">;</span><span class="token comment">//获取指针</span>
mov rax<span class="token punctuation">,</span>rsi<span class="token punctuation">;</span>
ret<span class="token punctuation">;</span>
reversal endp<span class="token punctuation">;</span>
</code></pre></div><ul><li>c++</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">reversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span><span class="token operator">*</span> array <span class="token operator">=</span> <span class="token function">reversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		cout <span class="token operator">&lt;&lt;</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>输出结果:<code>654321</code></p> <h2 id="call"><a href="#call" class="header-anchor">#</a> call</h2> <p>call指令用来调用一个过程 先把当前下一步的esp的指针push到栈里面
调用call的时候eip此时是call里面的指针
call在执行到ret的时候,此时就会把栈里面的esp指针内的返回地址pop
到eip里面接着往下执行</p> <p>如下所示:</p> <div class="language-c extra-class"><pre class="language-c"><code>     main PROC
<span class="token number">00000020</span>  call MySub<span class="token punctuation">;</span>等于push eip jmp MySub
<span class="token number">00000025</span>  mov eax<span class="token punctuation">,</span>ebx
</code></pre></div><p><img src="/img_7.png'" alt="img">&quot; alt=&quot;foo&quot;&gt;</p> <div class="language-c extra-class"><pre class="language-c"><code>   MySub PROC
<span class="token number">00000040</span> mov eaxz edx
      <span class="token punctuation">.</span>
      <span class="token punctuation">.</span>
      ret <span class="token punctuation">;</span>ret会 pop 返回地址<span class="token number">00000025</span><span class="token punctuation">(</span>原EIP<span class="token punctuation">)</span> 的地方接着执行 
   MySub END
</code></pre></div><img src="/asm/dist/img_9.png" alt="foo"> <ol><li>传参示例:
下面是传入一个数组并求和</li></ol> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> arr<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>观察寄存器得到参数分别是ecx和edx</p> <div class="language-c extra-class"><pre class="language-c"><code>callStackT proc
	call mm<span class="token punctuation">;</span>
	mov eax<span class="token punctuation">,</span>ebx<span class="token punctuation">;</span>
	ret<span class="token punctuation">;</span>
	callStackT endp

	dosum proc
	mov rax<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token punctuation">;</span>备份
	push rsi<span class="token punctuation">;</span>
	push rcx<span class="token punctuation">;</span>

	L1<span class="token operator">:</span>
	 add rax<span class="token punctuation">,</span><span class="token punctuation">[</span>rsi<span class="token punctuation">]</span><span class="token punctuation">;</span>
	 add rsi<span class="token punctuation">,</span>type dword<span class="token punctuation">;</span>
	 loop L1<span class="token punctuation">;</span>

	<span class="token punctuation">;</span>还原 rsi rcx 
	pop rcx<span class="token punctuation">;</span>
	pop rsi<span class="token punctuation">;</span>

	ret<span class="token punctuation">;</span>
dosum endp<span class="token punctuation">;</span>

sum proc
	mov rsi<span class="token punctuation">,</span>rcx<span class="token punctuation">;</span>
	mov rcx<span class="token punctuation">,</span>rdx<span class="token punctuation">;</span>
	call dosum<span class="token punctuation">;</span>
	call dosum<span class="token punctuation">;</span>
	ret<span class="token punctuation">;</span>
sum endp
</code></pre></div><p>结果输出为:<code>15</code></p> <h2 id="调用内置链接库"><a href="#调用内置链接库" class="header-anchor">#</a> 调用内置链接库</h2> <p>对于windows而言，内置了一些函数库：
<table><tbody><tr><th>
过程</th> <th>
说明</th></tr> <tr><td>
CloseFile</td> <td>
关闭之前已经打开的磁盘文件</td></tr> <tr><td>
Clrscr</td> <td>
清除控制台窗口，并将光标置于左上角</td></tr> <tr><td>
CreateOutputFile</td> <td>
为输出模式下的写操作创建一个新的磁盘文件</td></tr> <tr><td>
Crlf</td> <td>
在控制台窗口中写一个行结束的序列</td></tr> <tr><td>
Delay</td> <td>
程序执行暂停指定的 n 毫秒</td></tr> <tr><td>
DumpMem</td> <td>
以十六进制形式，在控制台窗口写一个内存块</td></tr> <tr><td>
DumpRegs</td> <td>
以十六进制形式显示 EAX、EEX、ECX、EDX、ESI、EDI、EBP、ESP、EFLAGS 和 EIP 寄存器。也显示最常见的 CPU 状态标志位</td></tr> <tr><td>
GetCommandTail</td> <td>
复制程序命名行参数（称为命令尾）到一个字节数组</td></tr> <tr><td>
GetDateTime</td> <td>
从系统获取当前日期和时间</td></tr> <tr><td>
GetMaxXY</td> <td>
返回控制台窗口缓冲器的行数和列数</td></tr> <tr><td>
GetMseconds</td> <td>
返回从午夜开始经过的毫秒数</td></tr> <tr><td>
GetTextColor</td> <td>
返回当前控制台窗口的前景色和背景色</td></tr> <tr><td>
Gotoxy</td> <td>
将光标定位到控制台窗口内指定的位置</td></tr> <tr><td>
IsDigit</td> <td>
如果 AL 寄存器中包含了十进制数字（0-9）的 ASCII 码，则零标志位置 1</td></tr> <tr><td>
MsgBox</td> <td>
显示一个弹出消息框</td></tr> <tr><td>
MsgBoxAsk</td> <td>
在弹出消息框中显示 yes/no 问题</td></tr> <tr><td>
OpenlnputFile</td> <td>
打开一个已有磁盘文件进行输入操作</td></tr> <tr><td>
ParseDecimal32</td> <td>
将一个无符号十进制整数字符串转换为 32 位二进制数</td></tr> <tr><td>
Parselnteger32</td> <td>
将一个有符号十进制整数字符串转换为 32 位二进制数</td></tr> <tr><td>
Random32</td> <td>
在 0〜FFFFFFFFh 范围内，生成一个 32 位的伪随机整数</td></tr> <tr><td>
Randomize</td> <td>
用一个值作为随机数生成器的种子</td></tr> <tr><td>
RandomRange</td> <td>
在特定范围内生成一个伪随机整数</td></tr> <tr><td>
ReadChar</td> <td>
等待从键盘输入一个字符，并返回该字符</td></tr> <tr><td>
ReadDec</td> <td>
从键盘读取一个无符号 32 位十进制整数，用回车符结束</td></tr> <tr><td>
ReadFromFile</td> <td>
将一个输入磁盘文件读入缓冲区</td></tr> <tr><td>
ReadHex</td> <td>
从键盘读取一个 32 位十六进制整数，用回车符结束</td></tr> <tr><td>
Readlnt</td> <td>
从键盘读取一个有符号 32 位十进制整数，用回车符结束</td></tr> <tr><td>
ReadKey</td> <td>
无需等待输入即从键盘输入缓冲区读取一个字符</td></tr> <tr><td>
ReadString</td> <td>
从键盘读取一个字符串，用回车符结束</td></tr> <tr><td>
SetTextColor</td> <td>
设置控制台输出字符的前景色和背景色</td></tr> <tr><td>
Str_compare</td> <td>
比较两个字符串</td></tr> <tr><td>
Str_copy</td> <td>
将源字符串复制到目的字符串</td></tr> <tr><td>
Str_length</td> <td>
用 EAX 返回字符串长度</td></tr> <tr><td>
Str_trim</td> <td>
从字符串删除不需要的字符</td></tr> <tr><td>
Str_ucase</td> <td>
将字符串转换为大写字母</td></tr> <tr><td>
WaitMsg</td> <td>
显示信息并等待按键操作</td></tr> <tr><td>
WriteBin</td> <td>
用 ASCII 二进制格式，向控制台窗口写一个无符号 32 位整数</td></tr> <tr><td>
WriteBinB</td> <td>
用字节、字或双字格式向控制台窗口写一个二进制整数</td></tr> <tr><td>
WriteChar</td> <td>
在控制台窗口写一个字符</td></tr> <tr><td>
WriteDec</td> <td>
用十进制格式，向控制台窗口写一个无符号 32 位整数</td></tr> <tr><td>
WriteHex</td> <td>
用十六进制格式，向控制台窗口写一个 32 位整数</td></tr> <tr><td>
WriteHexB</td> <td>
用十六进制格式，向控制台窗口写一个字节、字或双字整数</td></tr> <tr><td>
Writelnt</td> <td>
用十进制格式，向控制台窗口写一个有符号 32 位整数</td></tr> <tr><td>
WriteStackFrame</td> <td>
向控制台窗口写当前过程的堆栈帧</td></tr> <tr><td>
WriteStackFrameName</td> <td>
向控制台窗口写当前过程的名称和堆栈帧</td></tr> <tr><td>
WriteString</td> <td>
向控制台窗口写一个以空字符结束的字符串</td></tr> <tr><td>
WriteToFile</td> <td>
将缓冲区内容写入一个输出文件</td></tr> <tr><td>
WriteWindowsMsg</td> <td>
显示一个字符串，包含 MS-Windows 最近一次产生的错误</td></tr></tbody></table></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/13/2022, 10:49:29 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/asm/dist/asm/operator.html" class="prev">
        asm运算符和指令
      </a></span> <span class="next"><a href="/asm/dist/asm/bool.html">
        汇编条件跳转判断
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/asm/dist/assets/js/app.6634fcdc.js" defer></script><script src="/asm/dist/assets/js/2.c8a9966a.js" defer></script><script src="/asm/dist/assets/js/16.5fc6bad5.js" defer></script>
  </body>
</html>
