<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浮点数 | ASM</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="ASM教程">
    
    <link rel="preload" href="/asm/dist/assets/css/0.styles.bcf31e2a.css" as="style"><link rel="preload" href="/asm/dist/assets/js/app.adc25694.js" as="script"><link rel="preload" href="/asm/dist/assets/js/2.c8a9966a.js" as="script"><link rel="preload" href="/asm/dist/assets/js/12.3dfac32f.js" as="script"><link rel="prefetch" href="/asm/dist/assets/js/10.08d3736c.js"><link rel="prefetch" href="/asm/dist/assets/js/11.39670153.js"><link rel="prefetch" href="/asm/dist/assets/js/13.f4564c1a.js"><link rel="prefetch" href="/asm/dist/assets/js/14.97e5b17b.js"><link rel="prefetch" href="/asm/dist/assets/js/15.037dae28.js"><link rel="prefetch" href="/asm/dist/assets/js/16.f7b4fcb7.js"><link rel="prefetch" href="/asm/dist/assets/js/17.78f5766d.js"><link rel="prefetch" href="/asm/dist/assets/js/18.f16e4843.js"><link rel="prefetch" href="/asm/dist/assets/js/19.e86c10ed.js"><link rel="prefetch" href="/asm/dist/assets/js/20.b09eb6c1.js"><link rel="prefetch" href="/asm/dist/assets/js/21.83eba868.js"><link rel="prefetch" href="/asm/dist/assets/js/22.c1671d9d.js"><link rel="prefetch" href="/asm/dist/assets/js/23.c03a1a4d.js"><link rel="prefetch" href="/asm/dist/assets/js/24.eae9f11b.js"><link rel="prefetch" href="/asm/dist/assets/js/3.f5310743.js"><link rel="prefetch" href="/asm/dist/assets/js/4.bc7cf726.js"><link rel="prefetch" href="/asm/dist/assets/js/5.d250cb53.js"><link rel="prefetch" href="/asm/dist/assets/js/6.8779df89.js"><link rel="prefetch" href="/asm/dist/assets/js/7.cf8be782.js"><link rel="prefetch" href="/asm/dist/assets/js/8.f2edada3.js"><link rel="prefetch" href="/asm/dist/assets/js/9.14ba8cc7.js">
    <link rel="stylesheet" href="/asm/dist/assets/css/0.styles.bcf31e2a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/asm/dist/" class="home-link router-link-active"><!----> <span class="site-name">ASM</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/asm/dist/" class="nav-link">
  主页
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/asm/dist/" class="nav-link">
  主页
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/asm/dist/AsmSummarize.html" class="sidebar-link">asm教程概述</a></li><li><a href="/asm/dist/visualstudio/" class="sidebar-link">Visual Studio</a></li><li><a href="/asm/dist/cplus/" class="sidebar-link">c++基础</a></li><li><a href="/asm/dist/cplus/cClass.html" class="sidebar-link">C++的类</a></li><li><a href="/asm/dist/cplus/cAdvanced.html" class="sidebar-link">C++ 进阶</a></li><li><a href="/asm/dist/cplus/dll.html" class="sidebar-link">DLL</a></li><li><a href="/asm/dist/cplus/CC.html" class="sidebar-link">C#</a></li><li><a href="/asm/dist/asm/" aria-current="page" class="sidebar-link">asm概述</a></li><li><a href="/asm/dist/asm/basic.html" class="sidebar-link">asm基础</a></li><li><a href="/asm/dist/asm/operator.html" class="sidebar-link">asm运算符和指令</a></li><li><a href="/asm/dist/asm/stack.html" class="sidebar-link">堆栈与函数</a></li><li><a href="/asm/dist/asm/bool.html" class="sidebar-link">汇编条件跳转判断</a></li><li><a href="/asm/dist/asm/function.html" class="sidebar-link">高级函数过程</a></li><li><a href="/asm/dist/asm/float.html" aria-current="page" class="active sidebar-link">浮点数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#ieee浮点数表示" class="sidebar-link">IEEE浮点数表示</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#fpu" class="sidebar-link">FPU</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#xmm" class="sidebar-link">XMM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#mmword" class="sidebar-link">mmword</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#movsd" class="sidebar-link">movsd</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#addsd" class="sidebar-link">addsd</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#cvtsi2sd" class="sidebar-link">cvtsi2sd</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#comisd" class="sidebar-link">comisd</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#movaps" class="sidebar-link">movaps</a></li><li class="sidebar-sub-header"><a href="/asm/dist/asm/float.html#示例" class="sidebar-link">示例</a></li></ul></li></ul></li><li><a href="/asm/dist/asm/example.html" class="sidebar-link">汇编示例</a></li><li><a href="/asm/dist/ddt/" class="sidebar-link">弹弹堂</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浮点数"><a href="#浮点数" class="header-anchor">#</a> 浮点数</h1> <h2 id="ieee浮点数表示"><a href="#ieee浮点数表示" class="header-anchor">#</a> IEEE浮点数表示</h2> <blockquote><p>二进制的表示形式只做简要说明
<table><tbody><tr><td>
单精度</td> <td>
32 位：1 位符号位，8 位阶码，23 位为有效数字的小数部分。大致的规格化范围：2<sup>-126</sup> 〜2<sup>127</sup> 。也被称为短实数 (short real)</td></tr> <tr><td>
双精度</td> <td>
64 位：1 位符号位，11 位阶码，52 位为有效数字的小数部分。大致的规格化范围：2<sup>-1022</sup> 〜2<sup>1023</sup> 。也被称为长实数 (longreal)</td></tr> <tr><td>
扩展双精度</td> <td>
80 位：1 位符号位，15 位阶码，1 位为整数部分，63 位为有效数字的小数部分。大致的规格化范围：2<sup>-16382</sup>〜2<sup>16383</sup>。也被称为扩展实数 (extended real)</td></tr></tbody></table></p></blockquote> <ol><li>符号位
第一位代表符号 1是负数 0是正数</li> <li>表示方式
m*b^e 中 m是有效数字 b是基数 e是阶码 如:</li></ol> <p><code>1110.1 = (1.1101 * 2^3)</code></p> <p><code>.000101 = (1.01 X 2^-4)</code></p> <p><code>1010001. = (1.010001 x 26)</code></p> <ol start="3"><li>二进制表示
关于二进制表示的阶码得+127 也可称为偏移码
关于二进制小数形式如下:</li></ol> <div class="language- extra-class"><pre class="language-text"><code>0.5  = 1/2  = .1
0.25 = 1/4 = .01
..     1/8    = .001
..     3/8(1/4 + 1/8)    = .011  
</code></pre></div><p>推算如下</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token number">10.75</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>二进制浮点数形式<span class="token punctuation">)</span><span class="token number">1010.11</span> <span class="token operator">=</span><span class="token punctuation">(</span>格式化<span class="token punctuation">)</span> <span class="token number">1.01011</span> x2³ 
<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">2</span>³<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">=</span> <span class="token number">0</span> <span class="token number">10000010</span>  <span class="token punctuation">(</span><span class="token number">1010</span> <span class="token operator">=</span> <span class="token number">010</span><span class="token punctuation">)</span>   <span class="token number">11</span>  <span class="token number">000000000000000000</span>
<span class="token operator">=</span> <span class="token number">0</span> <span class="token number">10000010</span> <span class="token number">01011000000000000000000</span>
</code></pre></div><h2 id="fpu"><a href="#fpu" class="header-anchor">#</a> FPU</h2> <p>fpu为浮点数的寄存器
且与CPU是不同的单元</p> <ol><li>堆栈
与平常堆栈不同 FPU的堆栈和FPU的寄存器可以统称为一个
从R0~R7
push从 R3开始且每次-1 如果在push之前就是R0 则会绕到R7
pop从 R3开始 如果pop 之前就是R7则会绕到R0</li></ol> <p>与正常push指令不同 浮点数fld是入栈 且入到ST(0) 也就是R3</p> <p><img src="/img_12.png" alt="image"></p> <ol start="2"><li>计算</li></ol> <ul><li>FCHS ST(0)符号取反</li> <li>FABS ST(0)绝对值</li> <li>FADD ST(0)加法</li> <li>FADDP ST(0)加法并弹出</li> <li>FSUB ST(0)减法</li> <li>FSUBP ST(0)减法并弹出</li> <li>FMUL STO(0)乘法</li> <li>FMULP STO(0)乘法并弹出</li> <li>FDIV STO(0)除法</li> <li>FDIVP STO(0)除法并弹出</li></ul> <ol start="3"><li>比较</li></ol> <ul><li>FCOM 比较STO(0)</li> <li>FCOMP 比较STO(0)并弹出</li> <li>FCOMI 比较STO(0) 并设置标志位
比较结果会参数C3(ZF 零标志位) C2(PF 奇偶标志位) C1(ZF 进位标志位)</li></ul> <ol start="4"><li>跳转
FPU本身没有跳转 当可以通过<code>FNSTSW</code> 把状态 送入<code>ax</code>
然后在通过<code>sahf</code> 把<code>ah</code>状态值送入标志位寄存器
其中FCOMI是</li></ol> <div class="language-c extra-class"><pre class="language-c"><code>FCOM 
FNSTSW
SAHF 
</code></pre></div><p>整合</p> <ol start="6"><li>示例</li></ol> <ul><li>小于跳转</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token punctuation">;</span>x <span class="token operator">&lt;</span> y <span class="token operator">?</span> n <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">:</span> n<span class="token operator">=</span><span class="token number">0</span>
cmpN proc
fld x<span class="token punctuation">;</span> <span class="token function">st</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> x
FCOMP y<span class="token punctuation">;</span> <span class="token function">st</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> com y 弹出到<span class="token function">st</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
fnstsw ax<span class="token punctuation">;</span> 将CF ZF PF   状态位合并ax eax<span class="token operator">:</span><span class="token number">0100</span>
sahf     <span class="token punctuation">;</span>ah 移至 eflags 

jnb setN1<span class="token punctuation">;</span> y不小于x 跳转

setN1<span class="token operator">:</span>
  mov n<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span>
 
mov eax<span class="token punctuation">,</span>n<span class="token punctuation">;</span>

ret<span class="token punctuation">;</span>
cmpN endp<span class="token punctuation">;</span> 
</code></pre></div><h2 id="xmm"><a href="#xmm" class="header-anchor">#</a> XMM</h2> <p>与FPU 类似 形成XMM0 ~XMM15 循环寄存器</p> <p>SSE2命令过多,下面只是做简单的使用</p> <p>在此之前,先介绍简单的命令</p> <h3 id="mmword"><a href="#mmword" class="header-anchor">#</a> mmword</h3> <p>64位多媒体值的类型。形式为:0000000000000000-3FF3333333333333</p> <h3 id="movsd"><a href="#movsd" class="header-anchor">#</a> movsd</h3> <p>传送双个字节(double dword)=128<br>
一般用于传送XMM寄存器值</p> <h3 id="addsd"><a href="#addsd" class="header-anchor">#</a> addsd</h3> <p>累加双个字节 一般用于累加mmword类型数据</p> <h3 id="cvtsi2sd"><a href="#cvtsi2sd" class="header-anchor">#</a> cvtsi2sd</h3> <p>用于转换dword 类型到双精度浮点型</p> <h3 id="comisd"><a href="#comisd" class="header-anchor">#</a> comisd</h3> <p>比较双精度类型 并设置到 eflags(ZF PF CF)</p> <h3 id="movaps"><a href="#movaps" class="header-anchor">#</a> movaps</h3> <p>压缩成单精度浮点型对齐</p> <h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <p>下面的示例传入两个double(双精度) 数字</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">double</span> a <span class="token operator">+</span> b
<span class="token keyword">int</span> c<span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">&gt;</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>
   c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
   c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token operator">+</span>c<span class="token punctuation">;</span>
</code></pre></div><p>下面是翻译的汇编代码</p> <div class="language-c extra-class"><pre class="language-c"><code>
sumDouble proc

	movsd mmword ptr <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>xmm0<span class="token punctuation">;</span> a参数入栈
	movsd mmword ptr <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span>xmm1<span class="token punctuation">;</span> b参数入栈
	push rbp<span class="token punctuation">;</span>  备份还原
	mov rbp<span class="token punctuation">,</span>rsp<span class="token punctuation">;</span> 准备基址参数
	mov dword ptr <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">;</span> 局部变量c
	movsd xmm0<span class="token punctuation">,</span>mmword ptr <span class="token punctuation">[</span>rbp<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 取出参数a 到xmm0
	movsd xmm1<span class="token punctuation">,</span>mmword ptr<span class="token punctuation">[</span>rbp<span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 取出参数b到xmm1
	
	comisd xmm0<span class="token punctuation">,</span>xmm1<span class="token punctuation">;</span> a <span class="token operator">-</span> b
	jbe lessThan<span class="token punctuation">;</span> a <span class="token operator">&lt;=</span> b
	mov dword ptr <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span>		
	jmp L1<span class="token punctuation">;</span>
   
   <span class="token punctuation">;</span> a <span class="token operator">&lt;</span> b
	lessThan<span class="token operator">:</span>
		mov dword ptr <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>

	L1<span class="token operator">:</span>
		addsd xmm0<span class="token punctuation">,</span>xmm1<span class="token punctuation">;</span>累加a和b
		cvtsi2sd  xmm1<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//dword 到 双精度字节</span>

		addsd xmm0<span class="token punctuation">,</span>xmm1<span class="token punctuation">;</span>  <span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span> <span class="token operator">+</span> c
	
		add rsi<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">;</span> 删除局部变量
		pop rbp<span class="token punctuation">;</span> 还原rbp基址
		ret<span class="token punctuation">;</span>
sumDouble endp
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/4/2022, 10:46:04 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/asm/dist/asm/function.html" class="prev">
        高级函数过程
      </a></span> <span class="next"><a href="/asm/dist/asm/example.html">
        汇编示例
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/asm/dist/assets/js/app.adc25694.js" defer></script><script src="/asm/dist/assets/js/2.c8a9966a.js" defer></script><script src="/asm/dist/assets/js/12.3dfac32f.js" defer></script>
  </body>
</html>
